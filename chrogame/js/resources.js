/** * Created by Charles on 15/02/14. */function number_format (number, decimals) {    number = (number + '').replace(/[^0-9+\-Ee.]/g, '');    var n = !isFinite(+number) ? 0 : +number,        prec = !isFinite(+decimals) ? 0 : Math.abs(decimals),        sep = ' ', dec = ',' ,s = '',        toFixedFix = function (n, prec) {            var k = Math.pow(10, prec);            return '' + Math.round(n * k) / k;        };    // Fix for IE parseFloat(0.55).toFixed(0) = 0;    s = (prec ? toFixedFix(n, prec) : '' + Math.round(n)).split('.');    if (s[0].length > 3) {        s[0] = s[0].replace(/\B(?=(?:\d{3})+(?!\d))/g, sep);    }    if ((s[1] || '').length < prec) {        s[1] = s[1] || '';        s[1] += new Array(prec - s[1].length + 1).join('0');    }    return s.join(dec);}function launch(){    $("body").after("" +        "<div id='recap'>" +        "   <table>" +        "       <tbody>" +        "           <tr><td rowspan='3'><div class='resourceIcon metal'/></td><th>Disponible</th><td><span id='metalQ'/></td></tr>\n " +        "           <tr><th>Capacit\u00e9 de stockage</th>\n <td><span id='metalMax'/></td></tr>" +        "           <tr><th>Production actuelle\u00a0</th>\n <td><span  id='metalP' class='undermark'/></td></tr>" +        "       </tbody>" +        "       <tbody><tr><td colspan='3'>&nbsp;</td></tr></tbody>" +        "       <tbody>" +        "           <tr><td rowspan='3'><div class='resourceIcon crystal'/></td><th>Disponible</th><td><span id='cristalQ'/></td></tr>\n " +        "           <tr><th>Capacit\u00e9 de stockage</th>\n <td><span id='cristalMax'/></td></tr>" +        "           <tr><th>Production actuelle\u00a0</th>\n <td><span  id='cristalP' class='undermark'/></td></tr>" +        "       </tbody>" +        "       <tbody><tr><td colspan='3'>&nbsp;</td></tr></tbody>" +        "       <tbody>" +        "           <tr><td rowspan='3'><div class='resourceIcon deuterium'/></td><th>Disponible</th><td><span id='deuteriumQ'/></td></tr>" +        "           <tr><th>Capacit\u00e9 de stockage</th>\n <td><span id='deuteriumMax'/></td></tr>" +        "           <tr><th>Production actuelle\u00a0</th>\n <td><span  id='deuteriumP' class='undermark'/></td></tr>" +        "       </tbody>" +        "   </table>" +        "</div>");    $("#recap").css({"position": "absolute", "margin-left":"15px", "margin-top":"0px", "font-family":"Verdana", "font-size":"9px", "color": "#A6B8CB", "text-align" : "right"});    $("#recap table tbody tr td,#recap table tbody tr th").css({"padding" : "0 5px"});    var planetes = $("div[id^='planet-']");    var nbtotal =  planetes.length;    var nbReponses = 0;    var resultat = new Array();    planetes.each(function(index, elt){        var url = $(location).attr('protocol') +'//'+ $(location).attr('host') + $(location).attr('pathname') +'?page=fetchResources&cp=' + elt.id.substring(elt.id.indexOf("-")+1);        $.ajax({            url: url,            dataType: 'json',            success: function(data){                resultat.push(data);                nbReponses++;                if(nbReponses==nbtotal){                    manageData(resultat);                }            }        });    });}var data = {    "metal":{"resources":0,"production":0,"max":0},    "cristal":{"resources":0,"production":0,"max":0},    "deuterium":{"resources":0,"production":0,"max":0}};function manageData(resultat){    //on repositionne l'url...    $.ajax({url: $(".planetlink.active")[0].href});    $.each(resultat,function(key, value){        data.metal.resources +=value.metal.resources.actual;        data.metal.production +=value.metal.resources.production;        data.metal.max +=value.metal.resources.max;        data.cristal.resources +=value.crystal.resources.actual;        data.cristal.production +=value.crystal.resources.production;        data.cristal.max +=value.crystal.resources.max;        data.deuterium.resources +=value.deuterium.resources.actual;        data.deuterium.production +=value.deuterium.resources.production;        data.deuterium.max +=value.deuterium.resources.max;    });    $("#metalQ").text(number_format(data.metal.resources,0));    $("#metalP").text(number_format(data.metal.production * 60 * 60,0));    $("#metalMax").text(number_format(data.metal.max,0));    $("#cristalQ").text(number_format(data.cristal.resources,0));    $("#cristalP").text(number_format(data.cristal.production* 60 * 60,0));    $("#cristalMax").text(number_format(data.cristal.max,0));    $("#deuteriumQ").text(number_format(data.deuterium.resources,0));    $("#deuteriumP").text(number_format(data.deuterium.production* 60 * 60,0));    $("#deuteriumMax").text(number_format(data.deuterium.max,0));    (function() {setTimeout(refreshData, 1000);})();}function refreshData(){    $.each(data,function(key, value){        value.resources = value.resources + value.production;    });    $("#metalQ").text(number_format(data.metal.resources,0));    $("#cristalQ").text(number_format(data.cristal.resources,0));    $("#deuteriumQ").text(number_format(data.deuterium.resources,0));   (function() {setTimeout(refreshData, 1000);})();}window.addEventListener("load", $(document).ready(launch), false);